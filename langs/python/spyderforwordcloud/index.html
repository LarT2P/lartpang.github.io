<!DOCTYPE html>













<html class="theme-next pisces" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">



  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-center-simple.min.css?v=1.0.2" rel="stylesheet">




  
  
  <link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3">




<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.5.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.5.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.5.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.5.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="在之前的文章中，我们获得了豆瓣爬取的短评内容，汇总到了一个文件中，但是，没有被利用起来的数据是没有意义的。 前文提到，有一篇微信推文的关于词云制作的一个实践记录，准备照此试验一下。">
<meta name="keywords" content="python">
<meta property="og:type" content="article">
<meta property="og:title" content="利用豆瓣短评数据生成词云">
<meta property="og:url" content="https://plart.pw/langs/python/spyderforwordcloud/index.html">
<meta property="og:site_name" content="失乐园">
<meta property="og:description" content="在之前的文章中，我们获得了豆瓣爬取的短评内容，汇总到了一个文件中，但是，没有被利用起来的数据是没有意义的。 前文提到，有一篇微信推文的关于词云制作的一个实践记录，准备照此试验一下。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/2817465-4fed401bd994439e?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/2817465-b5570779fa57b746?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/2817465-4eec39379b930ad6?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:updated_time" content="2018-07-13T12:44:00.285Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="利用豆瓣短评数据生成词云">
<meta name="twitter:description" content="在之前的文章中，我们获得了豆瓣爬取的短评内容，汇总到了一个文件中，但是，没有被利用起来的数据是没有意义的。 前文提到，有一篇微信推文的关于词云制作的一个实践记录，准备照此试验一下。">
<meta name="twitter:image" content="http://upload-images.jianshu.io/upload_images/2817465-4fed401bd994439e?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">



  <link rel="alternate" href="/atom.xml" title="失乐园" type="application/atom+xml">




  <link rel="canonical" href="https://plart.pw/langs/python/spyderforwordcloud/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>利用豆瓣短评数据生成词云 | 失乐园</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta custom-logo">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">失乐园</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">代码与机器</h1>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    
  
  
  
  

  

    <a href="https://github.com/lartpang" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" style="fill: #222; color: #fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  
    <div class="reading-progress-bar"></div>
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://plart.pw/langs/python/spyderforwordcloud/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lart Pang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="失乐园">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">利用豆瓣短评数据生成词云
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-08-18 18:08:36" itemprop="dateCreated datePublished" datetime="2017-08-18T18:08:36+08:00">2017-08-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-07-13 20:44:00" itemprop="dateModified" datetime="2018-07-13T20:44:00+08:00">2018-07-13</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/编程与生活/" itemprop="url" rel="index"><span itemprop="name">编程与生活</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        <p>在之前的文章中，我们获得了豆瓣爬取的短评内容，汇总到了一个文件中，但是，没有被利用起来的数据是没有意义的。</p>
<p>前文提到，有一篇微信推文的关于词云制作的一个实践记录，准备照此试验一下。</p>
<a id="more"></a>
<h1 id="思路分析">思路分析</h1>
<h2 id="读文件">读文件</h2>
<p>利用<code>with open() as...</code>将文件读进来。这里需要注意文件内容的大小。</p>
<h2 id="分词">分词</h2>
<p>由于获取的是大量的短评文字，而制作词云需要的是各种词语，有了词，才能谈词云，所以目前第一步需求的就是讲短评内容拆分成一个个的中文词汇。</p>
<p>这里就用到了我所听过的一个库<code>jieba</code>，可以将中文语句拆解成一个个的词汇。这里是用的是<code>lcut()</code>方法，能将中文字符串拆解成一个列表，每项都是一个词。</p>
<h2 id="清洗非中文">清洗非中文</h2>
<p>但是，我们在分析中，需要的就是中文文字，所以需要将非中文字符彻底清理，这里使用了正则表达式。短小精悍的一个模式<code>[\u4e00-\u9fa5]+</code>即可匹配。</p>
<p>使用正则表达式，我的习惯是现在网上的一些在线正则表达式工具上直接测试。其中<code>oschina</code>的不错，还给提供了一些例子。</p>
<p><a href="http://tool.oschina.net/regex/" target="_blank" rel="noopener">在线正则表达式测试</a></p>
<p>这里是<code>oschina</code>的工具网站，做的很好。</p>
<p><a href="http://tool.oschina.net/" target="_blank" rel="noopener">工具分类索引</a></p>
<h2 id="处理停词">处理停词</h2>
<p>由于这些词汇中，有很多词是没有实际分析价值的，所以我们需要利用一个停词文件来将不必要的词处理掉。</p>
<p>参考文章中，是利用<code>pandas</code>库汇总的方法<code>read_csv()</code>来处理停词文件。，利用一个<code>isin()</code>方法实现了停词。</p>
<h2 id="聚合">聚合</h2>
<p>词分开了，基本也处理干净了。接下来应该考虑制作词云的问题。</p>
<p>我们这里想要重点突出在所有评论中的重要的<strong>核心观点</strong>，为了实现这样的目的，我们使用了分词。</p>
<p>这似乎是一种有些“<em>断章取义</em>”的思路。借助词频的分布实现重点突出高词频内容的方式，来展现我们的词云。</p>
<p>所以现在我们需要做的事，就是处理词汇的聚合问题，统计词频而已。</p>
<p>参考文种中利用了类<code>DataFrame</code>的分组方法<code>group()</code>和聚合方法<code>agg()</code>。</p>
<p>关于这里，参考文章中在<code>agg()</code>中使用了一个显式的字典（可见文末参考文章），调用了<code>numpy.size</code>，但是似乎是这种用法将来会被移除，查了一些文章，说是可以这样用，就是不能自己定制字典了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FutureWarning: using a dict on a Series <span class="keyword">for</span> aggregation <span class="keyword">is</span> deprecated <span class="keyword">and</span> will be removed <span class="keyword">in</span> a future version</span><br></pre></td></tr></table></figure>
<h2 id="词云">词云</h2>
<p>这里使用了第三方库<code>wordcloud</code>。这个库在安装的时候，直接<code>pip install wordcloud</code>时，我出了问题，提示微软开发工具的问题，折腾了半天，最后还是直接在<a href="http://www.lfd.uci.edu/~gohlke/pythonlibs/" target="_blank" rel="noopener">一个极为丰富的第三方库的集合站点上</a>下载使用<code>pip insatll</code>了它的<code>whl</code>文件。</p>
<p>这下可以正常使用了。</p>
<p>同时，这里为了能够显示处理图片，使用了<code>matplotlib.pyplot</code>&amp;<code>numpy</code>来进行处理。</p>
<h3 id="掩膜设置">掩膜设置</h3>
<p>由<a href="https://github.com/amueller/word_cloud" target="_blank" rel="noopener"><code>wordcloud项目主页README</code></a> 了解，可以使用二值图像来设定掩膜(mask)。</p>
<p>出于提升数据的表现力，也出于学习的目的，这里使用了直接编写的<code>rgb2gray()</code>&amp;<code>gray2bw()</code>函数来实现真彩图像转换为二值图像的过程。获得了最终的二值图像掩膜。</p>
<p>这里开始我并不知道需要怎样的图像，看了给的示例代码，用的图片的是二值图像，才明白，白白浪费了好多时间。</p>
<p>而且，我的理解，由彩色转为二值图像，是必要经过灰度图像这个过程的。</p>
<p>关于<code>matplotlib.pyplot</code>的使用，网上都说，和<code>matlab</code>的语法很类似，以前了解过一点，所以看着例子中的<code>imshow()</code>，很自然的就想出了<code>imread()</code>，实现了图片的读取。</p>
<p>在查阅文档的过程中发现了一个有意思的地方。</p>
<p><a href="http://matplotlib.org/api/pyplot_api.html?highlight=imshow#matplotlib.pyplot.imread" target="_blank" rel="noopener">文档</a></p>
<blockquote>
<p>Return value is a numpy.array. For grayscale images, the return array is MxN. For RGB images, the return value is MxNx3. For RGBA images the return value is MxNx4. matplotlib can only read PNGs natively, but if PIL is installed, it will use it to load the image and return an array (if possible) which can be used with imshow(). Note, URL strings may not be compatible with PIL. Check the PIL documentation for more information.</p>
</blockquote>
<p>我文中使用的是JPG图像，可见是调用了PIL处理。</p>
<p>而这里对于二值图像的获取，开始经历了一个误区。由于在网上搜索的时候，搜到的大多是利用<code>PIL</code>库的<code>Image</code>模块的<code>open()</code>&amp;<code>convert()</code>方法的处理，附加参数<code>1</code>，可以实现二值图像的转化，但是在这里使用，后面在使用词云的时候，会提示缺少属性，可见这里不适合这样处理。</p>
<h3 id="词云设定">词云设定</h3>
<p>词云支持自定义字体，背景颜色，掩膜设置等等，可以直接在IDE中跳至源文件中查看。都有相关的介绍。</p>
<p>文末代码是一些参数的摘录。</p>
<h3 id="词频选择">词频选择</h3>
<p>这里使用了刚才聚合排序好的数据，选择了前1000个词进行展示，并组合成字典，传入了词云的实例对象的方法<code>fit_words()</code>生成了词云。</p>
<h3 id="词云展示">词云展示</h3>
<p>这里使用了<code>matplotlib.pyplot</code>的的几个函数，实现了图像的保存，显示，以及坐标轴的隐藏。</p>
<p>这里倒是有个小异或，有点分不清楚<code>imshow()</code>与<code>show()</code>了。两者从文档我也没看出个所以然来。不过他们有个最明显的区别就是后者依赖图形窗口，但是前者似乎不需要。</p>
<p>要是有明白的，还请大家留言或者发邮件给我。</p>
<h1 id="完整代码">完整代码</h1>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">Created on Thu Aug 17 16:31:35 2017</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@note: 为了便于阅读，将模块的引用就近安置了</span></span><br><span class="line"><span class="string">@author: lart</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取事先爬取好的文件，由于文件较小，直接一次性读入。若文件较大，则最好分体积读入。</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'秘密森林的短评.txt'</span>, <span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> file:</span><br><span class="line">    comments = file.readlines()</span><br><span class="line">    comment = <span class="string">''</span>.join(comments)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 摘取中文字符，没有在下载时处理，正好保留原始数据。</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">pattern = re.compile(<span class="string">r'[\u4e00-\u9fa5]+'</span>)</span><br><span class="line">data = pattern.findall(comment)</span><br><span class="line">filted_comment = <span class="string">''</span>.join(data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分词</span></span><br><span class="line"><span class="keyword">import</span> jieba</span><br><span class="line"></span><br><span class="line">word = jieba.lcut(filted_comment)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 整理</span></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">words_df = pd.DataFrame(&#123;<span class="string">'words'</span>: word&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">#停词相关设置。参数 quoting=3 全不引用</span></span><br><span class="line">stopwords = pd.read_csv(</span><br><span class="line">        <span class="string">"stopwords.txt"</span>,</span><br><span class="line">        index_col=<span class="keyword">False</span>,</span><br><span class="line">        quoting=<span class="number">3</span>,</span><br><span class="line">        sep=<span class="string">"\t"</span>,</span><br><span class="line">        names=[<span class="string">'stopword'</span>],</span><br><span class="line">        encoding=<span class="string">'utf-8'</span></span><br><span class="line">        )</span><br><span class="line">words_df = words_df[~words_df.words.isin(stopwords.stopword)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 聚合</span></span><br><span class="line">words_stat = words_df.groupby(<span class="string">'words'</span>)[<span class="string">'words'</span>].agg(&#123;<span class="string">'size'</span>&#125;)</span><br><span class="line">words_stat = words_stat.reset_index().sort_values(<span class="string">"size"</span>, ascending=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 词云设置</span></span><br><span class="line"><span class="keyword">from</span> wordcloud <span class="keyword">import</span> WordCloud</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rgb2gray</span><span class="params">(rgb)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> np.dot(rgb[...,:<span class="number">3</span>], [<span class="number">0.299</span>, <span class="number">0.587</span>, <span class="number">0.114</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gray2bw</span><span class="params">(gray)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> raw <span class="keyword">in</span> range(len(gray)):</span><br><span class="line">        <span class="keyword">for</span> col <span class="keyword">in</span> range(len(gray[raw])):</span><br><span class="line">            gray[raw][col] = (<span class="number">0</span> <span class="keyword">if</span> gray[raw][col]&gt;<span class="number">50</span> <span class="keyword">else</span> <span class="number">255</span>)</span><br><span class="line">    <span class="keyword">return</span> gray</span><br><span class="line"></span><br><span class="line">img = plt.imread(<span class="string">'4.jpg'</span>)</span><br><span class="line">mask = rgb2gray(img)</span><br><span class="line">bw = gray2bw(mask)</span><br><span class="line"></span><br><span class="line">wordcloud = WordCloud(</span><br><span class="line">                font_path=<span class="string">"YaHei Consolas Hybrid.ttf"</span>,</span><br><span class="line">                background_color=<span class="string">"white"</span>,</span><br><span class="line">                mask=bw,</span><br><span class="line">                max_font_size=<span class="number">80</span></span><br><span class="line">                )</span><br><span class="line"><span class="comment"># word_frequence 为字典类型，可以直接传入wordcloud.fit_words()</span></span><br><span class="line">word_frequence = &#123;</span><br><span class="line">        x[<span class="number">0</span>]:x[<span class="number">1</span>] <span class="keyword">for</span> x <span class="keyword">in</span> words_stat.head(<span class="number">1000</span>).values</span><br><span class="line">        &#125;</span><br><span class="line">wordcloud = wordcloud.fit_words(word_frequence)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 存储显示</span></span><br><span class="line">plt.imsave(<span class="string">'img.jpg'</span>, wordcloud)</span><br><span class="line"></span><br><span class="line">plt.subplot(<span class="number">131</span>)</span><br><span class="line">plt.imshow(img)</span><br><span class="line">plt.axis(<span class="string">"off"</span>)</span><br><span class="line">plt.subplot(<span class="number">132</span>)</span><br><span class="line">plt.imshow(bw)</span><br><span class="line">plt.axis(<span class="string">"off"</span>)</span><br><span class="line">plt.subplot(<span class="number">133</span>)</span><br><span class="line">plt.imshow(wordcloud, interpolation=<span class="string">'bilinear'</span>)</span><br><span class="line">plt.axis(<span class="string">"off"</span>)</span><br></pre></td></tr></table></figure>
<h1 id="结果文件">结果文件</h1>
<p>使用的掩膜原图片：</p>
<p>秘密森林剧照</p>
<figure>
<img src="http://upload-images.jianshu.io/upload_images/2817465-4fed401bd994439e?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="秘密森林剧照"><figcaption>秘密森林剧照</figcaption>
</figure>
<p>输出图片</p>
<figure>
<img src="http://upload-images.jianshu.io/upload_images/2817465-b5570779fa57b746?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="输出图片"><figcaption>输出图片</figcaption>
</figure>
<p>IDE输出结果</p>
<figure>
<img src="http://upload-images.jianshu.io/upload_images/2817465-4eec39379b930ad6?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="这里写图片描述"><figcaption>这里写图片描述</figcaption>
</figure>
<h1 id="停词文件">停词文件</h1>
<p><a href="http://download.csdn.net/download/p_lart/9940528" target="_blank" rel="noopener">stopwords.txt</a></p>
<hr>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">Parameters</span><br><span class="line">----------</span><br><span class="line">font_path : string</span><br><span class="line"><span class="code">    Font path to the font that will be used (OTF or TTF).</span></span><br><span class="line"><span class="code">    Defaults to DroidSansMono path on a Linux machine. If you are on</span></span><br><span class="line"><span class="code">    another OS or don't have this font, you need to adjust this path.</span></span><br><span class="line"></span><br><span class="line">width : int (default=400)</span><br><span class="line"><span class="code">    Width of the canvas.</span></span><br><span class="line"></span><br><span class="line">height : int (default=200)</span><br><span class="line"><span class="code">    Height of the canvas.</span></span><br><span class="line"></span><br><span class="line">prefer_horizontal : float (default=0.90)</span><br><span class="line"><span class="code">    The ratio of times to try horizontal fitting as opposed to vertical.</span></span><br><span class="line"><span class="code">    If prefer_horizontal &lt; 1, the algorithm will try rotating the word</span></span><br><span class="line"><span class="code">    if it doesn't fit. (There is currently no built-in way to get only</span></span><br><span class="line"><span class="code">    vertical words.)</span></span><br><span class="line"></span><br><span class="line">mask : nd-array or None (default=None)</span><br><span class="line"><span class="code">    If not None, gives a binary mask on where to draw words. If mask is not</span></span><br><span class="line"><span class="code">    None, width and height will be ignored and the shape of mask will be</span></span><br><span class="line"><span class="code">    used instead. All white (#FF or #FFFFFF) entries will be considerd</span></span><br><span class="line"><span class="code">    "masked out" while other entries will be free to draw on. [This</span></span><br><span class="line"><span class="code">    changed in the most recent version!]</span></span><br><span class="line"></span><br><span class="line">scale : float (default=1)</span><br><span class="line"><span class="code">    Scaling between computation and drawing. For large word-cloud images,</span></span><br><span class="line"><span class="code">    using scale instead of larger canvas size is significantly faster, but</span></span><br><span class="line"><span class="code">    might lead to a coarser fit for the words.</span></span><br><span class="line"></span><br><span class="line">min<span class="emphasis">_font_</span>size : int (default=4)</span><br><span class="line"><span class="code">    Smallest font size to use. Will stop when there is no more room in this</span></span><br><span class="line"><span class="code">    size.</span></span><br><span class="line"></span><br><span class="line">font_step : int (default=1)</span><br><span class="line"><span class="code">    Step size for the font. font_step &gt; 1 might speed up computation but</span></span><br><span class="line"><span class="code">    give a worse fit.</span></span><br><span class="line"></span><br><span class="line">max_words : number (default=200)</span><br><span class="line"><span class="code">    The maximum number of words.</span></span><br><span class="line"></span><br><span class="line">stopwords : set of strings or None</span><br><span class="line"><span class="code">    The words that will be eliminated. If None, the build-in STOPWORDS</span></span><br><span class="line"><span class="code">    list will be used.</span></span><br><span class="line"></span><br><span class="line">background_color : color value (default="black")</span><br><span class="line"><span class="code">    Background color for the word cloud image.</span></span><br><span class="line"></span><br><span class="line">max<span class="emphasis">_font_</span>size : int or None (default=None)</span><br><span class="line"><span class="code">    Maximum font size for the largest word. If None, height of the image is</span></span><br><span class="line"><span class="code">    used.</span></span><br><span class="line"></span><br><span class="line">mode : string (default="RGB")</span><br><span class="line"><span class="code">    Transparent background will be generated when mode is "RGBA" and</span></span><br><span class="line"><span class="code">    background_color is None.</span></span><br><span class="line"></span><br><span class="line">relative_scaling : float (default=.5)</span><br><span class="line"><span class="code">    Importance of relative word frequencies for font-size.  With</span></span><br><span class="line"><span class="code">    relative_scaling=0, only word-ranks are considered.  With</span></span><br><span class="line"><span class="code">    relative_scaling=1, a word that is twice as frequent will have twice</span></span><br><span class="line"><span class="code">    the size.  If you want to consider the word frequencies and not only</span></span><br><span class="line"><span class="code">    their rank, relative_scaling around .5 often looks good.</span></span><br><span class="line"></span><br><span class="line"><span class="code">    .. versionchanged: 2.0</span></span><br><span class="line"><span class="code">        Default is now 0.5.</span></span><br><span class="line"></span><br><span class="line">color_func : callable, default=None</span><br><span class="line"><span class="code">    Callable with parameters word, font_size, position, orientation,</span></span><br><span class="line"><span class="code">    font_path, random_state that returns a PIL color for each word.</span></span><br><span class="line"><span class="code">    Overwrites "colormap".</span></span><br><span class="line"><span class="code">    See colormap for specifying a matplotlib colormap instead.</span></span><br><span class="line"></span><br><span class="line">regexp : string or None (optional)</span><br><span class="line"><span class="code">    Regular expression to split the input text into tokens in process_text.</span></span><br><span class="line"><span class="code">    If None is specified, ``r"\w[\w']+"`` is used.</span></span><br><span class="line"></span><br><span class="line">collocations : bool, default=True</span><br><span class="line"><span class="code">    Whether to include collocations (bigrams) of two words.</span></span><br><span class="line"></span><br><span class="line"><span class="code">    .. versionadded: 2.0</span></span><br><span class="line"></span><br><span class="line">colormap : string or matplotlib colormap, default="viridis"</span><br><span class="line"><span class="code">    Matplotlib colormap to randomly draw colors from for each word.</span></span><br><span class="line"><span class="code">    Ignored if "color_func" is specified.</span></span><br><span class="line"></span><br><span class="line"><span class="code">    .. versionadded: 2.0</span></span><br><span class="line"></span><br><span class="line">normalize_plurals : bool, default=True</span><br><span class="line"><span class="code">    Whether to remove trailing 's' from words. If True and a word</span></span><br><span class="line"><span class="code">    appears with and without a trailing 's', the one with trailing 's'</span></span><br><span class="line"><span class="code">    is removed and its counts are added to the version without</span></span><br><span class="line"><span class="code">    trailing 's' -- unless the word ends with 'ss'.</span></span><br></pre></td></tr></table></figure>

      
    </div>

    

    
    
    

    

    
       
    
    

    
      <div>
        



  



<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Lart Pang</li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    
    <a href="https://plart.pw/langs/python/spyderforwordcloud/" title="利用豆瓣短评数据生成词云">https://plart.pw/langs/python/spyderforwordcloud/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/python/" rel="tag"># python</a>
          
        </div>
      

      
      
        <div class="post-widgets">
        

        

        
          
          <div class="social_share">
            
            
               <div id="needsharebutton-postbottom">
                 <span class="btn">
                    <i class="fa fa-share-alt" aria-hidden="true"></i>
                 </span>
               </div>
            
          </div>
        
        </div>
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/langs/python/spyderfordouban/" rel="next" title="我的第一个豆瓣短评爬虫">
                <i class="fa fa-chevron-left"></i> 我的第一个豆瓣短评爬虫
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/langs/python/spyder_end/" rel="prev" title="关于近期爬虫学习的总结">
                关于近期爬虫学习的总结 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Lart Pang</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">58</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/lartpang" title="GitHub &rarr; https://github.com/lartpang" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:%6C%61%72%74%70%61%6E%67%40%31%36%33%2E%63%6F%6D" title="E-Mail &rarr; mailto:%6C%61%72%74%70%61%6E%67%40%31%36%33%2E%63%6F%6D" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://weibo.com/140jmx" title="Weibo &rarr; https://weibo.com/140jmx" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>Weibo</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#思路分析"><span class="nav-number">1.</span> <span class="nav-text">思路分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#读文件"><span class="nav-number">1.1.</span> <span class="nav-text">读文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分词"><span class="nav-number">1.2.</span> <span class="nav-text">分词</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#清洗非中文"><span class="nav-number">1.3.</span> <span class="nav-text">清洗非中文</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#处理停词"><span class="nav-number">1.4.</span> <span class="nav-text">处理停词</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#聚合"><span class="nav-number">1.5.</span> <span class="nav-text">聚合</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#词云"><span class="nav-number">1.6.</span> <span class="nav-text">词云</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#掩膜设置"><span class="nav-number">1.6.1.</span> <span class="nav-text">掩膜设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#词云设定"><span class="nav-number">1.6.2.</span> <span class="nav-text">词云设定</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#词频选择"><span class="nav-number">1.6.3.</span> <span class="nav-text">词频选择</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#词云展示"><span class="nav-number">1.6.4.</span> <span class="nav-text">词云展示</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#完整代码"><span class="nav-number">2.</span> <span class="nav-text">完整代码</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#结果文件"><span class="nav-number">3.</span> <span class="nav-text">结果文件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#停词文件"><span class="nav-number">4.</span> <span class="nav-text">停词文件</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 – <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lart Pang</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v6.5.0</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="总访客量">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="总访问量">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>












  













  



  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/reading_progress/reading_progress.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.5.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.5.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.5.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.5.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.5.0"></script>



  



  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  
  

  


  
  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "box";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
  </script>

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
          if(result)$(this).text('复制成功')
          else $(this).text('复制失败')
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('复制')
        }, 300)
      }).append(e)
    })
  </script>


  

</body>
</html>

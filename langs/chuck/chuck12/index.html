<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">



  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-center-simple.min.css?v=1.0.2" rel="stylesheet">




  
  
  <link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3">




<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.5.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico?v=6.5.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=6.5.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=6.5.0">


  <link rel="mask-icon" href="/images/favicon.ico?v=6.5.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.5.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="unit analyzers &amp;gt;new!!! declaring connecting controlling over time representing metadata: the UAnaBlob representing complex data performing analysis in UAna networks using events built-in un">
<meta name="keywords" content="ChucK">
<meta property="og:type" content="article">
<meta property="og:title" content="chuck12">
<meta property="og:url" content="https://plart.pw/langs/chuck/chuck12/index.html">
<meta property="og:site_name" content="失乐园">
<meta property="og:description" content="unit analyzers &amp;gt;new!!! declaring connecting controlling over time representing metadata: the UAnaBlob representing complex data performing analysis in UAna networks using events built-in un">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-07-13T12:46:25.276Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="chuck12">
<meta name="twitter:description" content="unit analyzers &amp;gt;new!!! declaring connecting controlling over time representing metadata: the UAnaBlob representing complex data performing analysis in UAna networks using events built-in un">



  <link rel="alternate" href="/atom.xml" title="失乐园" type="application/atom+xml">




  <link rel="canonical" href="https://plart.pw/langs/chuck/chuck12/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>chuck12 | 失乐园</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">失乐园</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">代码与机器</h1>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签<span class="badge">31</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类<span class="badge">6</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档<span class="badge">59</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    
  
  
  
  

  

    <a href="https://github.com/lartpang" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" style="fill: #222; color: #fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  
    <div class="reading-progress-bar"></div>
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://plart.pw/langs/chuck/chuck12/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lart Pang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="失乐园">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">chuck12
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-02-15 21:40:10" itemprop="dateCreated datePublished" datetime="2018-02-15T21:40:10+08:00">2018-02-15</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-07-13 20:46:25" itemprop="dateModified" datetime="2018-07-13T20:46:25+08:00">2018-07-13</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/编程与生活/" itemprop="url" rel="index"><span itemprop="name">编程与生活</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">21k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">37 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        <p>unit analyzers &gt;new!!!</p>
<pre><code>declaring
connecting
controlling over time
representing metadata: the UAnaBlob
representing complex data
performing analysis in UAna networks
using events
built-in unit analyzers
creating (coming soon) </code></pre>
<p>#Unit Analyzers 单元分析器</p>
<blockquote>
<p>Unit Analyzers (<strong>UAnae</strong>) are analyis building blocks, similar in concept to unit generators.They perform analysis functions on audio signals and/or metadata input, and produce metadata analysis results as output. (对音频信号或者元数据输入进行分析，把元数据分析结果作为输出) Unit analyzers can be linked together and with unit generators to form analysis/synthesis networks. Like unit generators, several unit analyzers may run concurrently, each dynamically(动态地) controlled at different rates. Because data passed between UAnae is not necessarily audio samples, and the relationship of UAna computation to time is fundamentally (根本地)different than that of UGens (e.g., UAnae might compute on blocks of samples, or on metadata), <em>the connections between UAnae have a different meaning from the connections between UGens formed with the ChucK operator, <code>=&gt;</code></em>. This difference is reflected in the choice of a new connection operator, the upChucK operator: <code>=^</code>. Another key difference between UGens and UAnae is that <strong>UAnae perform analysis (only) on demand, via the <code>upchuck()</code> function (see below).</strong></p>
</blockquote>
<p>Some more quick facts about ChucK unit analyzers:</p>
<ul>
<li>All ChucK unit analyzers are objects (not primitive(原始的) types).</li>
<li>All ChucK unit analyzers inherit(继承) from the <code>UAna</code> class.</li>
<li>The operation <code>foo =^ yah</code>, where foo and yah are UAnae, connects foo to yah.</li>
<li>Unit analyzer parameters(参数) and behaviors(行为) are controlled by calling / chucking to member functions over time, just like unit generators.</li>
<li>Analysis results are always stored in an object called a <code>UAnaBlob</code>. The <code>UAnaBlob</code> contains a time-stamp(时间标记) indicating(表明) when it was computed, and it may store an array(数组) of floats and/or complex(复杂的) values. <em>Each UAna specifies(指定) what information is present in the <code>UAnaBlob</code> it produces.</em>每个UAna指定它产生的UAnaBlob中的信息</li>
<li>All unit analyzers have the function <code>upchuck()</code>, which when called issues <em>a cascade of(一系列的) analysis computations for the unit analyzer and any &quot;upstream(上游的)&quot; unit analyzers on which its analysis depends.</em> (In the example of <code>foo =^ yah</code>, <code>yah.upchuck()</code> will result in <code>foo</code> first performing its analysis (possibly requesting analysis results from unit analyzers <em>further upstream</em>), then <code>yah</code>, <em>using <code>foo</code>'s analysis results in its computation</em>. <em><code>upchuck()</code> returns the analysis results in the form of a <code>UAnaBlob</code>.</em>)</li>
<li><p>Unit analyzers are specially integrated into the virtual(虚拟的) machine such that <em>each unit analyzer performs its analysis on its input whenever it or a downstream (下游的)<code>UAna</code> is <code>upchuck()</code>-ed.</em> Therefore, we have the ability to <em>assert(维护) control over the analysis process at any point in time and at any desired control rate</em>.</p>
<p><a href="http://chuck.cs.princeton.edu/doc/program/uana.html" target="_blank" rel="noopener">View a list</a> of ChucK's built-in(嵌入的) unit analyzer(分解) classes</p></li>
</ul>
<p>#declaring</p>
<p><em>Unit analyzers (UAnae) are objects, and they need to be instantiated before they can be used.</em></p>
<p>单元分析器是对象，使用前需要实例化</p>
<p>We declare unit analyzers the same way we declare UGens and other objects.</p>
<pre><code>// instantiate an FFT, assign reference to variable f
FFT f;</code></pre>
<p>#connecting</p>
<p>The upChucK operator (<code>=^</code>) is <em>only meaningful(有意义的) for unit analyzers</em>. Similar to the behavior(行为) of the ChucK operator between UGens, <strong>using <code>=^</code> to connect one UAna to another</strong> connects <strong>the analysis results of the first to the analysis input of the second</strong>.</p>
<pre><code>// instantiate FFT and flux objects, 
// connect to allow computation of spectrum(频谱) and spectral flux on adc input
adc =&gt; FFT fft =^ Flux flux =&gt; blackhole;</code></pre>
<p><strong>Note</strong> that the last UAna in any chain must be chucked to the <code>blackhole</code> or <code>dac</code> <em>to &quot;pull&quot; audio samples from the <code>adc</code> or other unit generators upstream.</em></p>
<p>It is also possible to linearly(线性的) chain many UAnae together in a single statement(声明). In the example below, the analysis of <code>flux_capacitor</code> depends on the results of <code>flux</code>, so the <code>flux</code> object will always perform its analysis computation before the computation of <code>flux_capacitor</code>.分析计算是先后执行的</p>
<pre><code>// Set up analysis on adc, via an FFT object, a spectral flux object, and a
// made-up object called a FluxCapacitor that operates on the flux value.
adc =&gt; FFT f =^ Flux flux =^ FluxCapacitor flux_capacitor =&gt; blackhole;</code></pre>
<p><strong>Very importantly</strong>, it is possible to create connection networks containing both <code>UAane</code> and <code>UGens</code>. In the example below, an <code>FFT</code> transforms(改变) two (added) sinusoidal(正弦曲线的) inputs, one of which has reverb(混响) added. An <code>IFFT</code> transforms the spectrum(频谱) back into the time domain(频域转换为时域), and the result is processed(处理) with a third sinusoid(正弦曲线) by a gain object before being played through the <code>dac</code>(被通过dac播放). (No, this example is not supposed to do anything musically interesting, only help you get a feel for the syntax(语法).) <strong>Notice</strong> that any connection through which <em>audio samples are passed</em> is denoted(表示) with the <code>=&gt;</code> operator, and the connection through which <em>spectral data is passed (from the FFT to the IFFT)</em> is denoted with the <code>=^</code> operator.</p>
<pre><code>//Chain a sine into a reverb, then perform FFT, then IFFT, then apply gain, then output
SinOsc s =&gt; JCRev r =&gt; FFT f =^ IFFT i =&gt; Gain g =&gt; dac;
// Chuck a second sine into the FFT
SinOsc s2 =&gt; f;
// Chuck a third sine into the final gain
SinOsc s3 =&gt; g;</code></pre>
<p><code>FFT</code>, <code>IFFT</code>, and other UAnae that perform transforms between the audio domain and another domain play a special role, as illustrated above(正如上文所述).</p>
<ul>
<li><code>FFT</code> takes audio samples(样品) as input, so unit generators connect to it with the ChucK operator <code>=&gt;</code>.</li>
<li>However, it outputs(输出) analysis results in the spectral domain, so it connects to other <em>UAnae</em> with the upChucK operator <code>=^</code>.</li>
<li>Conversely(相反的), UAnae producing spectral domain output connect to the <code>IFFT</code> using <code>=^</code>, and <code>IFFT</code> can connect to the <code>dac</code> or other <em>UGens</em> using <code>=&gt;</code>.</li>
</ul>
<p>This syntax(语法) allows the programmer to clearly reason about the expected behavior(行为) of <em>an analysis/synthesis(分析综合，分解重构) network</em>, while <strong>it hides the internal mechanics(内部机制) of ChucK timing and sample buffering from the programmer</strong>.</p>
<p>Finally, just as with unit generators, it is possible to dynamically (动态地)<strong>disconnect</strong> (拆开)unit analyzers, using the UnChucK operator (<code>=&lt;</code> or <code>!=&gt;</code>).</p>
<p>#controlling (over time)</p>
<p><strong>In any ChucK program, it is necessary to advance time in order to pull audio samples(样品) through the UGen network and create sound</strong>. Additionally(此外), <em>it is necessary to trigger(引发) analysis computations(计算) explicitly(显式地) in order for any analysis to be performed</em>, and for sound synthesis(合成) that depends on analysis results (e.g., <code>IFFT</code>) to be performed. To explicitly trigger computation at a point in time, the UAna's <code>upchuck()</code> member function is called.</p>
<p><code>upchuck()</code>：显式引发计算</p>
<p>In the example below, an FFT computation is triggered(引发) <em>every 1024 samples</em>.</p>
<pre><code>adc =&gt; FFT fft =&gt; dac;
// set the FFT to be of of size 2048 samples
2048 =&gt; fft.size;

while (true) {
// let 1024 samples pass
1024::samp =&gt; now;
// trigger the FFT computation on the last 2048 samples (the FFT size)
fft.upchuck();
}</code></pre>
<p>In the example above, because the <code>FFT</code> size is 2048 samples, the while-loop causes a standard &quot;sliding-window(滑动窗)&quot; <code>FFT</code> to be computed, where the hop size(步进值) is equal to half a window. However, ChucK allows you to perform analysis using nonstandard, dynamically(动态地) set, or even multiple hop sizes with the same object. 非标准的动态设定或者甚至多倍的步进大小 For example, in the code below, the <code>FFT</code> object <code>fft</code> performs computation every 5 seconds as triggered by <code>shred1</code>, and it additionally performs computation at a variable(可变的) rate as triggered by <code>shred2</code>.</p>
<pre><code>adc =&gt; FFT fft =&gt; dac;
2048 =&gt; fft.size;

// spork two shreds: shred1 and shred2
spork ~shred1();
spork ~shred2(); 
 
// shred1 computes FFT every 5 seconds
fun void shred1() {
    while (true) {
    5::second =&gt; now;
    fft.upchuck();
    }
}

// shred2 computes FFT every n seconds, where n is a random number between 1 and 10
fun void shred2() {
    while (true) {
    Std.rand2f(1, 10)::second =&gt; now;
    fft.upchuck();
    }
}</code></pre>
<p>Parameters(参数) of unit analyzers may be controlled and altered at any point in time and at any control rate. We only have to assert(维护) control at the appropriate(适当的) points as we move through time, by setting various parameters of the unit analyzer. <em>To set the a value for a parameter of a <code>UAna</code>, a value of the proper type should be ChucKed to the corresponding control function.</em></p>
<pre><code>// connect the input to an FFT
adc =&gt; FFT fft =&gt; blackhole;

//start with a size of 1024 and a Blackman-Harris window
1024 =&gt; fft.size;
Windowing.blackmanHarris(512) =&gt; fft.window;

//advance time and compute FFT
1::minute =&gt; now;
fft.upchuck();

// change window to Hamming
Windowing.hamming(512) =&gt; fft.window;

// let time pass... and carry on.</code></pre>
<p><em>Since the control functions are member functions of the unit analyzer, the above syntax(语法) is equilavent to calling functions.</em> For example, the line below could <strong>alternatively(作为选择)</strong> be used to change the FFT window to a Hamming window, as above.</p>
<pre><code>fft.window(Windowing.hamming(512));</code></pre>
<p>For a list of unit analyzers and their control methods, consult(查阅) <a href="http://chuck.cs.princeton.edu/doc/program/uana.html" target="_blank" rel="noopener">UAna reference</a>.</p>
<p>Just like unit generators, to read the current value of certain parameters of a <code>Uana</code>, we may call an overloaded function of the same name.就像单元发生器，读取当前Uana的某个参数的值，可以调用重载的同名函数 Additionally, assignments(分配) can be chained together when assigning(分配) one value to multiple targets.给多的目标分配一个值时，可以串联起来</p>
<pre><code>// connect adc to FFT
adc =&gt; FFT fft =&gt; blackhole;

// store the current value of the FFT size
fft.size() =&gt; int fft_size;</code></pre>
<p>What if a <code>UAna</code> that performs analysis on a group of audio samples(样品) is <code>upchuck()</code>-ed before its internal(内部的) buffer(缓冲区) is filled? This is possible if an FFT of size 1024 is instantiated(实例化), then <code>upchuck()</code>-ed after only 1000 samples, for example. In this case, the empty buffer slots(位置) are treated as 0's (that is, zero-padding(补零) is applied空的缓存区会被置零). This same behavior(行为) will occur if the FFT object's size is increased from 1024 to 2048, and then only 1023 samples pass after this change is applied; the last sample in the new (larger) buffer will be 0. <em>Keep in mind</em>, then, that certain analysis computations near the beginning of time and analysis computations after certain parameters(参数) have changed will logically(逻辑上) involve(包含) a short &quot;transient(短暂的)&quot; period.</p>
<pre><code>// connect adc to FFT to blackhole
adc =&gt; FFT fft =&gt; blackhole;
// set the FFT size to 1024 samples
1024 =&gt; fft.size;

// allow 1000 samples to pass
1000::samp =&gt; now;

// compute the FFT: the last 24 spots in the FFT buffer haven&#39;t been filled, so they are zero-ed out归零，置零
// the computation is nevertheless valid and proceeds.计算仍然是有效又有收益的。
fft.upchuck(); 

1::minute =&gt; now; // let time pass for a while

// increase the size of the FFT, and therefore the size of the sample buffer it uses
2048 =&gt; fft.size;

// let 1023 samples pass 
// 会填满1023个缓存点
1023::samp =&gt; now;

// at this point, only 2047 of the 2048 buffer spots have been filled
// 这处，2048中只有2047个缓存位置被填满——怎么算的？1000+24+1023
// the following computation therefore zeros out the last audio buffer spot
// 此句置零了最后一个音频缓存点
fft.upchuck();

1::minute =&gt; now; //let time pass for a while

// now the buffer is happy and full
fft.upchuck(); // proceeds normally on a full buffer</code></pre>
<p>#representing metadata: the <code>UAnaBlob</code></p>
<p>It is great to be able to trigger(引发) analysis computations like we've been doing above, but what if you want to actually <em>use</em> the analysis results? Luckily, calling the <code>upchuck()</code> function on a <code>UAna</code> returns a reference to <em>an object that stores the results of any <code>UAna</code> analysis</em>, called a <code>UanaBlob</code>. <code>UanaBlob</code>s can contain <strong>an array of floats</strong>, and/or <strong>an array of complex numbers</strong> (see the next section). The meaning and formatting(格式化) of the <code>UanaBlob</code> fields(字段) is different for each <code>UAna</code> subtype(子类型). <code>FFT</code>, for example (see <a href="chuck.cs.princeton.edu/doc/program/uana_full.html#FFT">specification</a>), fills in the complex array with the spectrum(频谱的复数数组) and the floating point array with the magnitude spectrum(振幅谱的浮点数组). Additionally, all <code>UanaBlob</code>s store the time when the <code>blob</code> was last computed.</p>
<p>The example below demonstrates(证明) how one might access(访问) the results of an FFT:</p>
<pre><code>adc =&gt; FFT fft =&gt; blackhole;
// ... set FFT parameters here ...

UAnaBlob blob;

while (true) {
    500::ms =&gt; now; // use hop size of 50 ms
    fft.upchuck() @=&gt; blob; // `store` the result in blob.
    blob.fvals() @=&gt; float mag_spec[]; // get the magnitude spectrum as float array
    blob.cvals() @=&gt; complex spec[]; // get the whole spectrum as complex array
    // get `the first bin`(这个指什么？？？) of the magnitude spectrum
    mag_spec[0] =&gt; float first_mag; 
    blob.fval(0) =&gt; float first_mag2; // equivalent way to get first bin of mag spectrum
    fft.upchuck().fval(0) =&gt; float first_mag3; // yet another equivalent way

    fft.upchuck().cval(0) =&gt; complex first_spec; // similarly, get 1st spectrum bin

    blob.when() =&gt; time when_computed; // get the time it was computed
} </code></pre>
<p><strong>Beware</strong>: whenever a <code>UAna</code> is <code>upchuck()</code>-ed, the contents of its previous <code>UAnaBlob</code> are overwritten. In the following code, <code>blob1</code> and <code>blob2</code> refer to <em>the same <code>UAnaBlob</code></em>. When <code>fft.upchuck()</code> is called the second time, the contents of the <code>UAnaBlob</code> referred to by <code>blob1</code> are overwritten.</p>
<pre><code>adc =&gt; FFT fft =&gt; blackhole;

UAnaBlob blob1, blob2;
1::minute =&gt; now; //let time pass for a while
fft.upchuck() @=&gt; blob1; // blob1 points to `the analysis results`
1::minute =&gt; now; // let time pass again
fft.upchuck() @=&gt; blob2; 
// now both blob1 and blob2 refer to the same object: **the new results!**</code></pre>
<p>Also <strong>beware</strong>: if time is not advanced between subsequent(后来的) <code>upchuck()</code>s of a <code>UAna</code>, any <code>upchuck()</code> after the first <em>will not re-compute the analysis</em>, even if <code>UAna</code> parameters have been changed. After the code below, <code>blob</code> refers to a <code>UAnaBlob</code> that is the result of computing the first (size 1024) FFT.指向第一次计算的结果的UAnaBlob</p>
<pre><code>adc =&gt; FFT fft =&gt; blackhole;
1024 =&gt; fft.size;

UAnaBlob blob;
1::minute =&gt; now; //let time pass for a while
fft.upchuck() @=&gt; blob; // blob holds the result of the FFT

512 =&gt; fft.size;
fft.upchuck() @=&gt; blob; 
// time hasn&#39;t advanced since the last computation, so no re-computation is done</code></pre>
<p>#representing complex data: the complex and polar types</p>
<p>In order to represent complex data, such as the output of an <code>FFT</code>, two new datatypes have been added to ChucK: complex and polar.</p>
<p>#performing analysis in UAna networks</p>
<p>Often, the computation of one <code>UAna</code> will depend on the computation results of &quot;upstream&quot; <code>UAnae</code>. For example, in the UAna network below, the spectral flux(频谱流量) is computed using the results of an <code>FFT</code>.</p>
<pre><code>adc =&gt; FFT fft =^ Flux flux =&gt; blackhole;</code></pre>
<p>The flow of computation in <code>UAna</code> networks is set up(设置) so that every time a <code>UAna</code> <code>a</code> is <code>upchuck()</code>-ed, each <code>UAna</code> whose output is connected to <code>a</code>'s input via <code>=^</code> is <code>upchuck()</code>-ed first, passing the results to <code>a</code> for it to use. For example, a call to <code>flux.upchuck()</code> will first force <code>fft</code> to compute an FFT on the audio samples in its buffer, then <code>flux</code> will use the <code>UanaBlob</code> from <code>fft</code> to compute the spectral flux. This flow of computation is handled <em>internally by ChucK</em>; you should understand the flow of control, but you don't need to do <code>fft.upchuck()</code> explicitly. Just writing code like that below will do the trick:</p>
<pre><code>adc =&gt; FFT fft =^ Flux flux =&gt; blackhole;
UAnaBlob blob;
while (true) {
    100::ms =&gt; now;
    flux.upchuck() @=&gt; blob; // causes fft to compute, then computes flux and stores result in blob
}</code></pre>
<p>Additionally, each time a <code>UAna</code> <code>upchuck()</code>s, its results are cached(缓存) until time passes. <em>This means that a <code>UAna</code> will only perform its computation once for a particular point in time.</em></p>
<pre><code>adc =&gt; FFT fft =^ Flux flux =&gt; blackhole;
fft =^ Centroid c =&gt; blackhole;

UAnaBlob blob, blob2;
while (true) {
    100::ms =&gt; now;
    flux.upchuck() @=&gt; blob; // causes fft to compute, then computes flux and stores result in blob
    c.upchuck() @=&gt; blob2; // uses cached fft results from previous line to compute centroid
}</code></pre>
<p><em>When no <code>upchuck()</code> is performed on a <code>UAna</code>, or on <code>UAnae</code> that depend on it</em>, it will not do computation. For example, in the network below, the flux is never computed.</p>
<pre><code>adc =&gt; FFT fft =^ Flux flux =&gt; blackhole;
UAnaBlob blob;
while (true) {
    100::ms =&gt; now;
    fft.upchuck() @=&gt; blob; // compute fft only
}</code></pre>
<p>The combination of this &quot;compute-on-demand&quot; behavior(这种按需计算行为的组合) and <code>UAna</code> caching means that different <code>UAnae</code> in a network can be <code>upchuck()</code>-ed at various/varying control rates, with maximum efficiency. In the example below, the <code>FFT</code>, <code>centroid</code>, and <code>flux</code> are all <em>computed at different rates</em>. When the analysis times for <code>flux</code> and <code>fft</code> or <code>centroid</code> and <code>fft</code> overlap(同时发生), <code>fft</code> is computed <em>just once</em> due to its <em>internal caching</em>. When it is an analysis time point for <code>fft</code> but not for <code>flux</code>, <code>flux</code> will not be computed.</p>
<pre><code>adc =&gt; FFT fft =^ Flux flux =&gt; blackhole;
fft =^ Centroid c =&gt; blackhole;
UAnaBlob blob1, blob2, blob3;

spork ~do_fft();
spork ~do_flux();
spork ~do_centroid();

while (true) {
    //Keep parent shred going
    1::minute =&gt; now;
    //感觉是多进程必要的一段代码
}

fun void do_fft() {
    while (true) {
        50::ms =&gt; now;
        fft.upchuck() @=&gt; blob1;
    }
}

fun void do_flux() {
    while (true) {
        110::ms =&gt; now;
        flux.upchuck() @=&gt; blob2;
    }
}

fun void do_centroid() {
    while (true) {
        250::ms =&gt; now;
        c.upchuck() @=&gt; blob3;
    }
}</code></pre>
<p>An easy way to synchronize analysis of many <code>UAnae</code> is to <code>upchuck()</code> an &quot;agglomerator(凝聚剂)&quot; <code>UAna</code>. In the example below, <code>agglom.upchuck()</code> triggers analysis of <em>all upstream UAnae</em> in the network. Because <code>agglom</code> is only a member of the <code>UAna</code> base class, it does no computation of its own. However, after <code>agglom.upchuck()</code>, all other <code>UAnae</code> will have up-to-date <em>results that are synchronized, computed, and cached</em> so that they are available to be accessed via <code>upchuck()</code> on each <code>UAna</code> (possibly by <em>a different shred</em> waiting for an event-- see below).</p>
<pre><code>adc =&gt; FFT fft =^ Flux flux =^ UAna agglom =&gt; blackhole;
fft =^ Centroid centroid =^ agglom;
// could add arbitrarily(反复地) many more UAnae that connect to agglom via =^

while (true) {
100::ms =&gt; now;
    agglom.upchuck(); // forces computation of both centroid and flux (and therefore fft, too)
}</code></pre>
<p><em>Because of the dependency and caching behavior of <code>upchuck()</code>-ing in <code>UAna</code> networks, <code>UAna</code> feedback loops should be used with caution</em>. In the network below, each time <code>c</code> is <code>upchuck()</code>-ed, it forces <code>b</code> to compute, which forces <code>a</code> to compute, which then recognizes that <code>b</code> has been traversed(遍历) in this upChucK path but has not been able to complete its computation-- thereby(因此) recognizing <code>a</code> loop in the network. <code>a</code> then uses <code>b</code>'s <em>last computed</em> <code>UAnaBlob</code> to perform its computation. This may or may not be desirable, so be careful.可能不理想</p>
<pre><code>adc =&gt; UAna a =^ UAna b =^ Uana c =&gt; blackhole;
b =^ a; // creates a feedback loop

while (true) {
    100::ms =&gt; now;
    c.upchuck(); // involves a using b&#39;s analysis results from 100 ms ago
}</code></pre>
<p>Another handy(方便的) UAna for synchronizing feature extraction(同步特征提取) is the <code>FeatureCollector</code>. Calling <code>upchuck()</code> on a <code>FeatureCollector</code> triggers computation of all upstream UAnae, and it concatenates(连接) their output blob data(BLOB二进制大数据) into a feature vector that can be used as input to a classifier(分类器), for example using <a href="http://smirk.cs.princeton.edu/" target="_blank" rel="noopener">smirk</a>.</p>
<pre><code>adc =&gt; FFT fft =^ Flux flux =^ FeatureCollector fc =&gt; blackhole;
fft =^ Centroid centroid =^ fc;
// could add abitrarily many more UAnae that connect to fc via =^

while (true) {
    100::ms =&gt; now;
    // forces computation of both centroid and flux (and therefore fft, too)
    // an vectorBlob&#39;s fvals and cvals will be a concatenation(连接) of the feature values
    fc.upchuck() @=&gt; UAnaBlob vectorBlob; 
}</code></pre>
<p>#built-in unit analyzers</p>
<p>ChucK has a number of built-in UAna classes. These classes perform many basic transform(变换) functions (FFT, IFFT) and feature extraction(特征提取) methods (both spectral and time-domain features(频域时域特征)). A list of built-in ChucK <em>unit analyzers</em> can be found <a href="http://chuck.cs.princeton.edu/doc/program/uana.html" target="_blank" rel="noopener">here</a>.</p>
<p>#creating</p>
<p>( someday soon you will be able to implement your own unit analyzers! ) 单元分析器的个人实现</p>

      
    </div>

    

    
    
    

    

    
       
    
    

    
      <div>
        



  



<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Lart Pang</li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    
    <a href="https://plart.pw/langs/chuck/chuck12/" title="chuck12">https://plart.pw/langs/chuck/chuck12/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/ChucK/" rel="tag"># ChucK</a>
          
        </div>
      

      
      
        <div class="post-widgets">
        

        

        
          
          <div class="social_share">
            
            
               <div id="needsharebutton-postbottom">
                 <span class="btn">
                    <i class="fa fa-share-alt" aria-hidden="true"></i>
                 </span>
               </div>
            
          </div>
        
        </div>
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/langs/chuck/chuck6/" rel="next" title="chuck6">
                <i class="fa fa-chevron-left"></i> chuck6
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/langs/chuck/chuck4/" rel="prev" title="chuck4">
                chuck4 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Lart Pang">
            
              <p class="site-author-name" itemprop="name">Lart Pang</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">59</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">31</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/lartpang" title="GitHub &rarr; https://github.com/lartpang" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:%6C%61%72%74%70%61%6E%67%40%31%36%33%2E%63%6F%6D" title="E-Mail &rarr; mailto:%6C%61%72%74%70%61%6E%67%40%31%36%33%2E%63%6F%6D" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://weibo.com/140jmx" title="Weibo &rarr; https://weibo.com/140jmx" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>Weibo</a>
                </span>
              
            </div>
          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.csdn.net/p_lart" title="https://blog.csdn.net/p_lart" rel="noopener" target="_blank">csdn</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.jianshu.com/u/f381f4c8dca4" title="https://www.jianshu.com/u/f381f4c8dca4" rel="noopener" target="_blank">简书</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 – <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lart Pang</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="站点总字数">358k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="站点阅读时长">10:51</span>
  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v6.5.0</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="总访客量">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="总访问量">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>












  













  



  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/reading_progress/reading_progress.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.5.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.5.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.5.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.5.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.5.0"></script>



  



  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  
  

  


  
  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "box";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
  </script>

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
          if(result)$(this).text('复制成功')
          else $(this).text('复制失败')
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('复制')
        }, 300)
      }).append(e)
    })
  </script>


  

</body>
</html>
